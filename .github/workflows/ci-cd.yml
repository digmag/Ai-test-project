name: CI/CD Pipeline for starbly-server

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  cleanup:
    runs-on: self-hosted  # Используем self-hosted runner для starbly-server
    steps:
    - name: Clean up Docker containers and images
      run: |
        # Остановка и удаление контейнеров с тестами
        docker stop test-app-* 2>/dev/null || true
        docker rm test-app-* 2>/dev/null || true

        # Остановка и удаление контейнеров hospital_management_app
        docker stop hospital_management_app* 2>/dev/null || true
        docker rm hospital_management_app* 2>/dev/null || true

        # Остановка и удаление контейнеров hospital_management_redis
        docker stop hospital_management_redis* 2>/dev/null || true
        docker rm hospital_management_redis* 2>/dev/null || true

        # Удаление всех остановленных контейнеров
        docker container prune -f 2>/dev/null || true

        # Удаление образов hospital-management
        docker rmi $(docker images -q hospital-management) 2>/dev/null || true

        # Удаление всех неиспользуемых образов
        docker image prune -f 2>/dev/null || true

  test:
    runs-on: self-hosted  # Используем self-hosted runner для starbly-server
    needs: cleanup

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run unit tests
      run: |
        python -m unittest test_app.py -v

  build:
    runs-on: self-hosted  # Используем self-hosted runner для starbly-server
    needs: test

    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build Docker image
      run: |
        docker build -t hospital-management:latest .

    - name: Test Docker image
      run: |
        docker run --rm hospital-management:latest python -c "import main; print('Application imports successfully')"

    - name: Run application briefly to test
      run: |
        docker run -d --name test-app-${{ github.run_number }} -p 8888:8888 hospital-management:latest
        sleep 10
        docker logs test-app-${{ github.run_number }}
        docker stop test-app-${{ github.run_number }}
        docker rm test-app-${{ github.run_number }}

  deploy:
    runs-on: self-hosted  # Используем self-hosted runner для starbly-server
    needs: [test, build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - uses: actions/checkout@v3

    - name: Build and tag Docker image for deployment
      run: |
        docker build -t hospital-management:${{ github.sha }} .
        docker tag hospital-management:${{ github.sha }} hospital-management:latest

    - name: Deploy to starbly-server
      run: |
        # Копируем production docker-compose файл
        cp docker-compose.prod.yml docker-compose.yml

        # Остановка старого контейнера, если он существует
        docker-compose down || true

        # Удаляем старые образы hospital-management
        docker rmi $(docker images -q hospital-management) 2>/dev/null || true

        # Удаляем остановленные контейнеры
        docker container prune -f 2>/dev/null || true

        # Запускаем новую версию приложения
        docker-compose up -d

        # Ждем, пока приложение запустится
        sleep 15

        # Проверяем статус сервисов
        docker-compose ps